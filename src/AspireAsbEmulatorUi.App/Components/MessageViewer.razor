@using AspireAsbEmulatorUi.App.Services
@using AspireAsbEmulatorUi.App.Models
@using System.Text.Json
@inject ServiceBusService Bus
@inject SettingsService SettingsService
@inject IJSRuntime JS

<div>
    <h3 class="text-lg font-medium mb-2">Viewer for @DisplayName</h3>

    <div class="flex items-center gap-3 mb-3">
        <div class="flex rounded bg-slate-700 p-1">
            <button class=@($"px-3 py-1 rounded-l text-sm {(_isDlqSelected ? "text-slate-400" : "bg-blue-600 text-white")}") @onclick="() => SelectDlq(false)">Main</button>
            <button class=@($"px-3 py-1 rounded-r text-sm {(_isDlqSelected ? "bg-blue-600 text-white" : "text-slate-400")}") @onclick="() => SelectDlq(true)">Dead-letter</button>
        </div>

        <!-- Peek/Receive toggle -->
        <div class="flex rounded bg-slate-700 p-1">
            <button class=@($"px-3 py-1 rounded-l text-sm {(!_isReceive ? "bg-blue-600 text-white" : "text-slate-200")}") @onclick="() => SelectReceive(false)">Peek</button>
            <button class=@($"px-3 py-1 rounded-r text-sm {(_isReceive ? "bg-red-600 text-white" : "text-slate-200")}") @onclick="() => SelectReceive(true)">Receive</button>
        </div>

        <input type="number" min="1" max="100" @bind="_maxMessages" class="w-20 bg-slate-800 border border-slate-700 rounded px-2 py-1" />
        <button class="px-3 py-1 rounded bg-blue-600 text-white hover:bg-blue-700" @onclick="LoadMessages">Load</button>
    </div>

    @if (_isReceive)
    {
        <div class="rounded p-3 mb-3 bg-red-800 text-red-100">
            Warning: Receive mode is destructive and will remove messages from the queue.
        </div>
    }

    <div class="space-y-3">
        @if (_messages is null)
        {
            <div class="text-slate-400">Messages not loaded.</div>
        }
        else if (!_messages.Any())
        {
            <div class="text-slate-400">No messages.</div>
        }
        else
        {
            foreach (var m in _messages)
            {
                <div class="bg-slate-700 p-3 rounded">
                    <div class="flex items-start justify-between">
                        <div>
                            <div class="text-sm font-semibold">Sequence: @m.SequenceNumber</div>
                            <div class="text-xs text-slate-400">Correlation: @m.CorrelationId</div>
                            <div class="text-xs text-slate-400">Enqueued: @m.EnqueuedTime</div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button class="text-sm px-2 py-1 rounded border border-slate-600" @onclick:stopPropagation="true" @onclick="() => ToggleBroker(m)" title="Show Broker Props">Broker</button>
                            <button class="text-sm px-2 py-1 rounded border border-slate-600" @onclick:stopPropagation="true" @onclick="() => ToggleApp(m)" title="Show Application Props">Application</button>
                            <button class="text-sm px-2 py-1 rounded border border-slate-600" @onclick:stopPropagation="true" @onclick="() => CopyMessage(m)" title="Copy message to clipboard">Copy</button>
                            <button class="text-sm px-2 py-1 rounded bg-blue-600 text-white hover:bg-blue-700" @onclick:stopPropagation="true" @onclick="() => SaveMessageAsCanned(m)" title="Save as canned message">Save as Canned</button>
                        </div>
                    </div>

                    <div class="mt-2 bg-slate-800 p-2 rounded text-sm">
                        <div class="font-mono whitespace-pre-wrap">@m.Body</div>
                    </div>

                    @if (_showBroker.Contains(m.SequenceNumber))
                    {
                        <div class="mt-2 bg-slate-800 p-2 rounded text-sm">
                            <div class="font-semibold">Broker Properties</div>
                            <ul class="list-disc list-inside">
                                @foreach (var kv in m.BrokerProperties.Where(kv => kv.Value != null))
                                {
                                    <li>@kv.Key: @System.Text.Json.JsonSerializer.Serialize(kv.Value)</li>
                                }
                            </ul>
                        </div>
                    }

                    @if (_showApp.Contains(m.SequenceNumber))
                    {
                        <div class="mt-2 bg-slate-800 p-2 rounded text-sm">
                            <div class="font-semibold">Application Properties</div>
                            <ul class="list-disc list-inside">
                                @foreach (var kv in m.ApplicationProperties)
                                {
                                    <li>@kv.Key: @System.Text.Json.JsonSerializer.Serialize(kv.Value)</li>
                                }
                            </ul>
                        </div>
                    }
                </div>
            }
        }
    </div>
</div>

@if (_showSaveDialog)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @onclick="() => _showSaveDialog = false">
        <div class="bg-slate-800 rounded-lg p-6 max-w-md w-full mx-4" @onclick:stopPropagation="true">
            <h4 class="text-lg font-semibold mb-4">Save as Canned Message</h4>
            <div class="space-y-3">
                <div>
                    <label class="text-sm text-slate-400 block mb-1">Entity Name</label>
                    <input class="w-full bg-slate-900 border border-slate-700 text-slate-100 px-3 py-2 rounded" 
                           @bind="_cannedEntityName" 
                           placeholder="e.g., myqueue or mytopic" />
                </div>
                <div>
                    <label class="text-sm text-slate-400 block mb-1">Scenario Name</label>
                    <input class="w-full bg-slate-900 border border-slate-700 text-slate-100 px-3 py-2 rounded" 
                           @bind="_cannedScenarioName" 
                           placeholder="e.g., test scenario" />
                </div>
                @if (!string.IsNullOrEmpty(_saveResult))
                {
                    <div class="text-sm @(_saveResultSuccess ? "text-green-400" : "text-red-400")">
                        @_saveResult
                    </div>
                }
                <div class="flex gap-2 mt-4">
                    <button class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700" @onclick="SaveCannedMessage">Save</button>
                    <button class="px-4 py-2 rounded bg-slate-600 text-white hover:bg-slate-500" @onclick="() => { _showSaveDialog = false; _saveResult = string.Empty; }">Cancel</button>
                </div>
            </div>
        </div>
    </div>
}

@code{
    [Parameter] public string SelectedEntity { get; set; } = string.Empty;
    [Parameter] public string DisplayName { get; set; } = string.Empty;

    private int _maxMessages = 20;
    private List<DisplayedMessage>? _messages;
    private bool _isDlqSelected = false;
    private bool _isReceive = false; // false = peek, true = receive

    private HashSet<long> _showBroker = new();
    private HashSet<long> _showApp = new();

    private bool _showSaveDialog = false;
    private string _cannedEntityName = string.Empty;
    private string _cannedScenarioName = string.Empty;
    private string _saveResult = string.Empty;
    private bool _saveResultSuccess = false;
    private DisplayedMessage? _messageToSave = null;

    protected override void OnParametersSet()
    {
        // Clear messages when selection changes
        _messages = null;
    }

    private void SelectDlq(bool dlq)
    {
        _isDlqSelected = dlq;
        _messages = null;
    }

    private void SelectReceive(bool receive)
    {
        _isReceive = receive;
        _messages = null;
    }

    private void ToggleBroker(DisplayedMessage m)
    {
        if (_showBroker.Contains(m.SequenceNumber)) _showBroker.Remove(m.SequenceNumber);
        else _showBroker.Add(m.SequenceNumber);
    }

    private void ToggleApp(DisplayedMessage m)
    {
        if (_showApp.Contains(m.SequenceNumber)) _showApp.Remove(m.SequenceNumber);
        else _showApp.Add(m.SequenceNumber);
    }

    private async Task LoadMessages()
    {
        if (string.IsNullOrWhiteSpace(SelectedEntity)) return;
        _messages = new List<DisplayedMessage>();
        try
        {
            var target = SelectedEntity + (_isDlqSelected ? "/$DeadLetterQueue" : string.Empty);
            if (!_isReceive)
            {
                var msgs = await Bus.PeekMessagesAsync(target, _maxMessages);
                _messages.AddRange(msgs);
            }
            else
            {
                var msgs = await Bus.ReceiveMessagesAsync(target, _maxMessages);
                _messages.AddRange(msgs);
            }
        }
        catch (Exception ex)
        {
            _messages.Add(new DisplayedMessage { Body = $"Error: {ex.Message}" });
        }
    }

    private async Task CopyMessage(DisplayedMessage m)
    {
        // Build a nicely formatted string
        var sb = new System.Text.StringBuilder();
        sb.AppendLine($"MessageId: {m.MessageId}");
        sb.AppendLine($"SequenceNumber: {m.SequenceNumber}");
        sb.AppendLine($"CorrelationId: {m.CorrelationId}");
        sb.AppendLine($"Enqueued: {m.EnqueuedTime}");
        sb.AppendLine($"ExpiresAt: {m.ExpiresAt}");
        sb.AppendLine("--- Broker Properties ---");
        foreach (var kv in m.BrokerProperties)
        {
            sb.AppendLine($"{kv.Key}: {System.Text.Json.JsonSerializer.Serialize(kv.Value)}");
        }
        sb.AppendLine("--- Application Properties ---");
        foreach (var kv in m.ApplicationProperties)
        {
            sb.AppendLine($"{kv.Key}: {System.Text.Json.JsonSerializer.Serialize(kv.Value)}");
        }
        sb.AppendLine("--- Body ---");
        sb.AppendLine(m.Body);

        await JS.InvokeVoidAsync("navigator.clipboard.writeText", sb.ToString());
    }

    private void SaveMessageAsCanned(DisplayedMessage m)
    {
        _messageToSave = m;
        _cannedEntityName = SelectedEntity;
        _cannedScenarioName = string.Empty;
        _saveResult = string.Empty;
        _saveResultSuccess = false;
        _showSaveDialog = true;
    }

    private void SaveCannedMessage()
    {
        if (_messageToSave == null)
        {
            _saveResult = "No message to save";
            _saveResultSuccess = false;
            return;
        }

        if (string.IsNullOrWhiteSpace(_cannedEntityName) || string.IsNullOrWhiteSpace(_cannedScenarioName))
        {
            _saveResult = "Please provide both entity and scenario names";
            _saveResultSuccess = false;
            return;
        }

        try
        {
            var settings = SettingsService.GetSettings();
            
            // Ensure entity exists in canned messages
            if (!settings.CannedMessages.ContainsKey(_cannedEntityName))
            {
                settings.CannedMessages[_cannedEntityName] = new Dictionary<string, CannedMessage>();
            }

            // Extract broker properties (excluding null values, default values, and system-generated ones)
            var brokerProps = new Dictionary<string, object>();
            foreach (var kv in _messageToSave.BrokerProperties.Where(kv => kv.Value != null))
            {
                var key = kv.Key;
                var value = kv.Value!; // We know it's not null from the Where clause
                
                // Skip system-generated properties that shouldn't be in canned messages
                if (key == "SequenceNumber" || key == "EnqueuedSequenceNumber" || 
                    key == "EnqueuedTime" || key == "LockToken" || key == "LockedUntil" || 
                    key == "State" || key == "DeliveryCount" || key == "ExpiresAt")
                    continue;
                
                // Skip properties with default values
                if (IsDefaultValue(value))
                    continue;
                
                brokerProps[key] = value;
            }

            // Filter application properties to only include non-null and non-default values
            var appProps = _messageToSave.ApplicationProperties
                .Where(p => p.Value != null && !IsDefaultValue(p.Value))
                .ToDictionary(p => p.Key, p => p.Value!);

            // Create the canned message (only include properties dictionaries if they have values)
            var cannedMessage = new CannedMessage
            {
                ContentType = _messageToSave.ContentType ?? "application/json",
                Body = _messageToSave.Body
            };

            if (appProps.Any())
                cannedMessage.ApplicationProperties = appProps;
            
            if (brokerProps.Any())
                cannedMessage.BrokerProperties = brokerProps;

            settings.CannedMessages[_cannedEntityName][_cannedScenarioName] = cannedMessage;
            SettingsService.UpdateSettings(settings);

            _saveResult = $"Saved as: {_cannedEntityName}/{_cannedScenarioName}";
            _saveResultSuccess = true;
            
            // Close dialog after short delay
            _ = Task.Run(async () =>
            {
                await Task.Delay(1500);
                await InvokeAsync(() =>
                {
                    _showSaveDialog = false;
                    _saveResult = string.Empty;
                    StateHasChanged();
                });
            });
        }
        catch (Exception ex)
        {
            _saveResult = $"Error: {ex.Message}";
            _saveResultSuccess = false;
        }
    }

    private bool IsDefaultValue(object value)
    {
        if (value == null)
            return true;

        var type = value.GetType();

        // Check for default values of common types
        if (type == typeof(string))
            return string.IsNullOrEmpty((string)value);
        
        if (type == typeof(int))
            return (int)value == 0;
        
        if (type == typeof(long))
            return (long)value == 0;
        
        if (type == typeof(bool))
            return (bool)value == false;
        
        if (type == typeof(DateTime))
            return (DateTime)value == default(DateTime);
        
        if (type == typeof(DateTimeOffset))
            return (DateTimeOffset)value == default(DateTimeOffset);
        
        if (type == typeof(TimeSpan))
            return (TimeSpan)value == default(TimeSpan);
        
        if (type == typeof(Guid))
            return (Guid)value == default(Guid);

        // For other types, check if it equals the default value
        try
        {
            var defaultValue = Activator.CreateInstance(type);
            return value.Equals(defaultValue);
        }
        catch
        {
            // If we can't determine, assume it's not default
            return false;
        }
    }
}
