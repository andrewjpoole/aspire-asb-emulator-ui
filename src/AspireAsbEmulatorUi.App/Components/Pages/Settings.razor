@page "/settings"
@rendermode InteractiveServer
@using AspireAsbEmulatorUi.App.Models
@using AspireAsbEmulatorUi.App.Services
@using System.Text.Json
@using BlazorMonaco
@using BlazorMonaco.Editor
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.JSInterop
@inject SettingsService SettingsService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>Settings</PageTitle>

<main class="max-w-screen-2xl mx-auto p-6">
    <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-4">            
            <h1 class="text-2xl font-semibold">ASB Emulator Explorer Settings</h1>            
        </div>        
        <div class="flex items-center gap-3">
            <button class="px-3 py-2 rounded flex items-center bg-blue-600 text-white hover:bg-blue-700" 
                    @onclick="SaveSettings">
                <span class="text-sm">Save Settings</span>
            </button>
            <button class="px-3 py-2 rounded bg-slate-700 text-slate-100 hover:bg-slate-600 flex items-center gap-2" @onclick="NavigateHome">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="white">
                    <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                </svg>
                <span class="text-sm">Back to explorer</span>
            </button>
        </div>        
    </div>
    <p class="text-sm text-slate-400 mb-3">Changes here are immediate but only persisted in-memory, to survive a restart of Aspire you will need to export them and import the file in the Aspire AppHost.</p>
    
    <InputFile @ref="_fileInputComponent" 
               OnChange="HandleFileSelected" 
               accept=".json,application/json" 
               style="display: none;" />

    @if (!string.IsNullOrEmpty(_message))
    {
        <div class="mb-4 p-3 rounded bg-blue-800 text-blue-100">
            @_message
        </div>
    }

    <div class="space-y-6">
        <!-- Content Types Card -->
        <div class="bg-slate-800 rounded p-6">
            <h2 class="text-xl font-semibold mb-4">Content Types</h2>
            <p class="text-sm text-slate-400 mb-3">Define which content types should be available in the dropdown when sending messages and which one should be the default.</p>
            <div class="space-y-2">
                @foreach (var ct in _settings.ContentTypes.Select((v, i) => (v, i)))
                {
                    <div class="flex gap-2 items-center">
                        <input class="flex-1 bg-slate-900 border border-slate-700 text-slate-100 px-3 py-2 rounded" @bind="_settings.ContentTypes[ct.i]" />
                        <button class="px-3 py-2 rounded border border-slate-600 text-slate-100 hover:bg-slate-700" @onclick="() => RemoveContentType(ct.i)">Remove</button>
                    </div>
                }
                <div class="flex gap-2 items-center">
                    <input placeholder="New content type" class="flex-1 bg-slate-900 border border-slate-700 text-slate-100 px-3 py-2 rounded" @bind="_newContentType" />
                    <button class="px-3 py-2 rounded bg-blue-600 text-white hover:bg-blue-700" @onclick="AddContentType">Add</button>
                </div>
            </div>

            <div class="mt-4">
                <label class="text-sm text-slate-400 block mb-2">Default Content Type</label>
                <select @bind="_settings.DefaultContentType" class="bg-slate-900 border border-slate-700 text-slate-100 px-3 py-2 rounded w-full">
                    @foreach (var ct in _settings.ContentTypes)
                    {
                        <option value="@ct">@ct</option>
                    }
                </select>
            </div>
        </div>

        <!-- Common Application Properties Card -->
        <div class="bg-slate-800 rounded p-6">
            <h2 class="text-xl font-semibold mb-4">Common Application Properties</h2>
            <p class="text-sm text-slate-400 mb-3">Add frequently used application properties. Multiple properties with the same name are allowed.</p>
            <div class="space-y-2">
                @foreach (var prop in _settings.CommonApplicationProperties.Select((kv, i) => (kv, i)))
                {
                    <div class="flex gap-2 items-center">
                        <input class="w-1/3 bg-slate-900 border border-slate-700 text-slate-100 px-3 py-2 rounded" 
                               value="@prop.kv.Key" readonly title="Property name" />
                        <input class="flex-1 bg-slate-900 border border-slate-700 text-slate-100 px-3 py-2 rounded" 
                               value="@prop.kv.Value" readonly title="Property value" />
                        <button class="px-3 py-2 rounded border border-slate-600 text-slate-100 hover:bg-slate-700" @onclick="() => RemoveCommonProperty(prop.i)">Remove</button>
                    </div>
                }
                <div class="flex gap-2 items-center">
                    <input placeholder="Property name" class="w-1/3 bg-slate-900 border border-slate-700 text-slate-100 px-3 py-2 rounded" @bind="_newCommonPropKey" />
                    <input placeholder="Property value" class="flex-1 bg-slate-900 border border-slate-700 text-slate-100 px-3 py-2 rounded" @bind="_newCommonPropValue" />
                    <button class="px-3 py-2 rounded bg-blue-600 text-white hover:bg-blue-700" @onclick="AddCommonProperty">Add</button>
                </div>
            </div>
        </div>

        <!-- Canned Messages Card -->
        <div class="bg-slate-800 rounded p-6">
            <h2 class="text-xl font-semibold mb-4">Canned Messages</h2>            
            <p class="text-sm text-slate-400 mb-3">
                Define CannedMessages to send, organised by Scenario, for one or more Entities (hint: use * wildcard to match multiple or all Entities).
                <br/>
                These will be available in a dropdown when sending messages for matching Entities.
            </p>
            <div class="space-y-4">
                @foreach (var entity in _settings.CannedMessages)
                {
                    <div class="bg-slate-700 rounded p-4">
                        <div class="flex items-center justify-between mb-3">
                            @if (_editingEntityName == entity.Key)
                            {
                                <div class="flex items-center gap-2 flex-1">
                                    <span class="text-sm text-slate-400">Entity:</span>
                                    <input class="bg-slate-900 border border-slate-700 text-slate-100 px-2 py-1 rounded flex-1" 
                                           @bind="_newEntityNameValue" 
                                           placeholder="Entity name" />
                                    <button class="px-2 py-1 rounded bg-blue-600 text-white hover:bg-blue-700 text-sm" @onclick="() => SaveEntityNameEdit(entity.Key)">Save</button>
                                    <button class="px-2 py-1 rounded border border-slate-600 text-slate-100 hover:bg-slate-600 text-sm" @onclick="CancelEntityNameEdit">Cancel</button>
                                </div>
                            }
                            else
                            {
                                <div class="flex items-center gap-2">
                                    <h4 class="font-semibold">Entity: @entity.Key</h4>                                   
                                </div>
                                <div class="flex gap-2">
                                    <button class="px-2 py-1 rounded border border-slate-600 text-slate-100 hover:bg-slate-600 text-sm" @onclick="() => StartEditingEntityName(entity.Key)">Rename</button>
                                    <button class="px-2 py-1 rounded border border-slate-600 text-slate-100 hover:bg-slate-600 text-sm" @onclick="() => RemoveEntity(entity.Key)">Remove Entity</button>
                                </div>
                            }
                        </div>
                        
                        @foreach (var scenario in entity.Value)
                        {
                            var scenarioKey = $"{entity.Key}:{scenario.Key}";
                            <div class="bg-slate-800 rounded p-3 mb-2">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="font-medium">Scenario: @scenario.Key</span>
                                    <div class="flex gap-2">
                                        <button class="px-2 py-1 rounded border border-slate-600 text-slate-100 hover:bg-slate-700 text-sm" @onclick="() => DuplicateScenario(entity.Key, scenario.Key)">Duplicate</button>
                                        <button class="px-2 py-1 rounded border border-slate-600 text-slate-100 hover:bg-slate-700 text-sm" @onclick="() => RemoveScenario(entity.Key, scenario.Key)">Remove</button>
                                    </div>
                                </div>
                                <button class="text-sm px-2 py-1 rounded border border-slate-600 text-slate-100 hover:bg-slate-700" @onclick="() => ToggleScenarioDetails(entity.Key, scenario.Key)">
                                    @(_expandedScenarios.Contains(scenarioKey) ? "Hide Details" : "Show Details")
                                </button>
                                
                                @if (_expandedScenarios.Contains(scenarioKey))
                                {
                                    @if (scenario.Value != null && scenario.Value.ContentType != null && scenario.Value.Body != null)
                                    {
                                        <div class="mt-3 space-y-4">
                                            <div>
                                                <label class="text-xs text-slate-400 block mb-1">Content Type</label>
                                                <input class="w-full bg-slate-900 border border-slate-700 text-slate-100 px-2 py-1 rounded text-sm" @bind="scenario.Value.ContentType" />
                                            </div>
                                            <div>
                                                <label class="text-xs text-slate-400 block mb-1">Body</label>
                                                <div class="relative">
                                                    <textarea class="w-full bg-slate-900 border border-slate-700 text-slate-100 px-2 py-1 rounded text-sm font-mono" 
                                                              rows="8" 
                                                              readonly 
                                                              value="@scenario.Value.Body">@scenario.Value.Body</textarea>
                                                    <button type="button" 
                                                            class="absolute top-2 right-2 px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm"
                                                            @onclick="@(() => OpenBodyEditor(entity.Key, scenario.Key))">
                                                        Edit
                                                    </button>
                                                </div>
                                            </div>
            
                                            @if (_appPropsLists.ContainsKey(scenarioKey))
                                            {
                                                <div class="border-t border-slate-700 pt-3">
                                                    <ApplicationPropertiesEditor 
                                                        Title="Application Properties"
                                                        Properties="@_appPropsLists[scenarioKey]"
                                                        OnPropertiesChanged="@(() => SaveAppPropertiesFromList(entity.Key, scenario.Key))" />
                                                </div>
                                            }
            
                                            @if (_brokerPropsLists.ContainsKey(scenarioKey))
                                            {
                                                <div class="border-t border-slate-700 pt-3">
                                                    <BrokerPropertiesEditor 
                                                        Title="Broker Properties"
                                                        Properties="@_brokerPropsLists[scenarioKey]"
                                                        OnPropertiesChanged="@(() => SaveBrokerPropertiesFromList(entity.Key, scenario.Key))"
                                                        OnMessage="@((m) => { _message = m; StateHasChanged(); })" />
                                                </div>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="mt-3 p-3 rounded bg-slate-900 text-slate-400">
                                            Message data is missing or corrupted. 
                                            <button class="ml-2 px-2 py-1 rounded bg-blue-600 text-white text-xs" @onclick="() => InitializeMessage(entity.Key, scenario.Key)">Initialize</button>
                                        </div>
                                    }
                                }
                            </div>
                        }
                        
                        <div class="mt-2">
                            @if (!_newScenarioNames.ContainsKey(entity.Key))
                            {
                                _newScenarioNames[entity.Key] = string.Empty;
                            }
                            <input placeholder="New scenario name" class="bg-slate-900 border border-slate-700 text-slate-100 px-2 py-1 rounded text-sm" 
                                   @bind="_newScenarioNames[entity.Key]" />
                            <button class="ml-2 px-2 py-1 rounded bg-blue-600 text-white hover:bg-blue-700 text-sm" @onclick="() => AddScenario(entity.Key)">Add Scenario</button>
                        </div>
                    </div>
                }
                
                <div class="flex gap-2">
                    <input placeholder="Enter an ASB Entity name, use * wildcard to match multiple..." class="flex-1 bg-slate-900 border border-slate-700 text-slate-100 px-3 py-2 rounded" @bind="_newEntityName" />
                    <button class="px-3 py-2 rounded bg-blue-600 text-white hover:bg-blue-700" @onclick="AddEntity">Add Entity</button>
                </div>
            </div>
        </div>

        <!-- Import/Export Card -->
        <div class="bg-slate-800 rounded p-6">
            <h2 class="text-xl font-semibold mb-4">Import/Export Settings</h2>
            <p class="text-sm text-slate-400 mb-4">Import settings from a JSON file or export your current settings to backup or share.</p>
            <div class="flex gap-3">
                <button class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 flex items-center gap-2" @onclick="TriggerFileImport">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                    Import Settings from File
                </button>
                <button class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 flex items-center gap-2" @onclick="ExportSettings">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                    </svg>
                    Export Settings to File
                </button>
            </div>
        </div>
    </div>
</main>

@if (_showDuplicateDialog)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-slate-800 rounded-lg p-6 max-w-md w-full mx-4 border border-slate-700">
            <h3 class="text-lg font-semibold mb-4">Duplicate Scenario</h3>
            <div class="space-y-3">
                <div>
                    <label class="text-sm text-slate-400 block mb-1">Original: @_duplicateSourceScenario</label>
                </div>
                <div>
                    <label class="text-sm text-slate-400 block mb-1">New Scenario Name</label>
                    <input class="w-full bg-slate-900 border border-slate-700 text-slate-100 px-3 py-2 rounded" 
                           @bind="_duplicateNewName" 
                           placeholder="Enter new scenario name"
                           @onkeydown="HandleDuplicateKeyDown" />
                </div>
            </div>
            <div class="flex gap-2 mt-4">
                <button class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700" @onclick="ConfirmDuplicate">Duplicate</button>
                <button class="px-4 py-2 rounded border border-slate-600 text-slate-100 hover:bg-slate-700" @onclick="CancelDuplicate">Cancel</button>
            </div>
            @if (!string.IsNullOrEmpty(_duplicateError))
            {
                <div class="mt-3 p-2 rounded bg-red-900 text-red-100 text-sm">
                    @_duplicateError
                </div>
            }
        </div>
    </div>
}

@* Modal for editing scenario body *@
@if (_showBodyEditorModal)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @onclick="CloseBodyEditor">
        <div class="bg-slate-800 rounded-lg p-6 w-11/12 h-5/6 max-w-6xl flex flex-col" @onclick:stopPropagation="true">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-slate-100">Edit Scenario Body - @_editingScenarioKey</h2>
                <button type="button" class="text-slate-400 hover:text-slate-100 text-2xl" @onclick="CloseBodyEditor">&times;</button>
            </div>
            <div class="flex-1 border border-slate-700 rounded overflow-hidden">
                <StandaloneCodeEditor 
                    @ref="_modalBodyEditor" 
                    Id="modal-body-editor"
                    CssClass="h-full w-full"
                    ConstructionOptions="GetModalEditorConstructionOptions"
                    OnDidInit="OnModalEditorInit" />
            </div>
            <div class="flex gap-2 mt-4">
                <button type="button" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700" @onclick="SaveBodyEditorChanges">Save</button>
                <button type="button" class="px-4 py-2 rounded border border-slate-600 text-slate-100 hover:bg-slate-700" @onclick="CloseBodyEditor">Cancel</button>
            </div>
        </div>
    </div>
}

@code {
    private Models.Settings _settings = new();
    private string _message = string.Empty;
    
    private string _newContentType = string.Empty;
    private string _newCommonPropKey = string.Empty;
    private string _newCommonPropValue = string.Empty;
    private string _newEntityName = string.Empty;
    private Dictionary<string, string> _newScenarioNames = new();
    
    private HashSet<string> _expandedScenarios = new();
    
    // Property lists cache for the editors
    private Dictionary<string, List<ApplicationPropertiesEditor.PropertyItem>> _appPropsLists = new();
    private Dictionary<string, List<BrokerPropertiesEditor.PropertyItem>> _brokerPropsLists = new();
    
    // Modal body editor
    private StandaloneCodeEditor? _modalBodyEditor;
    private bool _showBodyEditorModal = false;
    private string _editingScenarioKey = string.Empty;
    private string _modalEditingEntityName = string.Empty;
    private string _modalEditingScenarioName = string.Empty;
    
    // Entity name editing fields
    private string? _editingEntityName = null;
    private string _newEntityNameValue = string.Empty;

    // File input component reference
    private InputFile? _fileInputComponent;

    // Duplicate scenario dialog fields
    private bool _showDuplicateDialog = false;
    private string _duplicateEntityName = string.Empty;
    private string _duplicateSourceScenario = string.Empty;
    private string _duplicateNewName = string.Empty;
    private string _duplicateError = string.Empty;

    protected override void OnInitialized()
    {
        _settings = SettingsService.GetSettings();
        InitializePropertyLists();
    }

    // Start editing an entity name
    private void StartEditingEntityName(string entityName)
    {
        _editingEntityName = entityName;
        _newEntityNameValue = entityName;
        StateHasChanged();
    }

    // Cancel editing entity name
    private void CancelEntityNameEdit()
    {
        _editingEntityName = null;
        _newEntityNameValue = string.Empty;
        StateHasChanged();
    }

    // Save the edited entity name
    private void SaveEntityNameEdit(string oldEntityName)
    {
        if (string.IsNullOrWhiteSpace(_newEntityNameValue))
        {
            _message = "Entity name cannot be empty";
            _editingEntityName = null;
            StateHasChanged();
            return;
        }

        if (_newEntityNameValue == oldEntityName)
        {
            CancelEntityNameEdit();
            return;
        }

        if (_settings.CannedMessages.ContainsKey(_newEntityNameValue))
        {
            _message = $"Entity '{_newEntityNameValue}' already exists";
            StateHasChanged();
            return;
        }

        if (_settings.CannedMessages.TryGetValue(oldEntityName, out var scenarios))
        {
            _settings.CannedMessages.Remove(oldEntityName);
            _settings.CannedMessages[_newEntityNameValue] = scenarios;
            
            if (_newScenarioNames.ContainsKey(oldEntityName))
            {
                var value = _newScenarioNames[oldEntityName];
                _newScenarioNames.Remove(oldEntityName);
                _newScenarioNames[_newEntityNameValue] = value;
            }
            
            var keysToRename = _appPropsLists.Keys.Where(k => k.StartsWith($"{oldEntityName}:")).ToList();
            foreach (var oldKey in keysToRename)
            {
                var scenarioName = oldKey.Substring(oldEntityName.Length + 1);
                var newKey = $"{_newEntityNameValue}:{scenarioName}";
                
                if (_appPropsLists.ContainsKey(oldKey))
                {
                    _appPropsLists[newKey] = _appPropsLists[oldKey];
                    _appPropsLists.Remove(oldKey);
                }
                
                if (_brokerPropsLists.ContainsKey(oldKey))
                {
                    _brokerPropsLists[newKey] = _brokerPropsLists[oldKey];
                    _brokerPropsLists.Remove(oldKey);
                }
                
                if (_expandedScenarios.Contains(oldKey))
                {
                    _expandedScenarios.Remove(oldKey);
                    _expandedScenarios.Add(newKey);
                }
            }
            
            _message = $"Renamed entity from '{oldEntityName}' to '{_newEntityNameValue}'";
        }
        
        _editingEntityName = null;
        _newEntityNameValue = string.Empty;
        StateHasChanged();
    }

    private void InitializePropertyLists()
    {
        _appPropsLists.Clear();
        _brokerPropsLists.Clear();
        
        foreach (var entity in _settings.CannedMessages)
        {
            foreach (var scenario in entity.Value)
            {
                var key = $"{entity.Key}:{scenario.Key}";
                
                var msg = scenario.Value;
                if (msg == null)
                {
                    _appPropsLists[key] = new List<ApplicationPropertiesEditor.PropertyItem>();
                    _brokerPropsLists[key] = new List<BrokerPropertiesEditor.PropertyItem>();
                    continue;
                }
                
                // Initialize app properties list
                _appPropsLists[key] = (msg.ApplicationProperties ?? new Dictionary<string, object>())
                    .Select(kv => new ApplicationPropertiesEditor.PropertyItem 
                    { 
                        Key = kv.Key, 
                        Value = kv.Value?.ToString() ?? string.Empty 
                    })
                    .ToList();
                
                // Initialize broker properties list
                _brokerPropsLists[key] = (msg.BrokerProperties ?? new Dictionary<string, object>())
                    .Select(kv => new BrokerPropertiesEditor.PropertyItem 
                    { 
                        Key = kv.Key, 
                        Value = kv.Value?.ToString() ?? string.Empty 
                    })
                    .ToList();
            }
         }
     }

    private StandaloneEditorConstructionOptions GetEditorConstructionOptions(StandaloneCodeEditor editor, string scenarioKey)
    {
        var parts = scenarioKey.Split(':');
        var entityName = parts[0];
        var scenarioName = parts[1];
        
        string body = "{}";
        string contentType = "application/json";
        
        if (_settings.CannedMessages.TryGetValue(entityName, out var scenarios) &&
            scenarios.TryGetValue(scenarioName, out var msg) &&
            msg != null)
        {
            body = msg.Body ?? "{}";
            contentType = msg.ContentType ?? "application/json";
        }
        
        return new StandaloneEditorConstructionOptions
        {
            AutomaticLayout = true,
            Language = GetMonacoLanguage(contentType),
            Theme = "vs-dark",
            Value = body,
            Minimap = new EditorMinimapOptions { Enabled = false },
            ScrollBeyondLastLine = false,
            FontSize = 13,
            TabSize = 2
        };
    }

    // Modal body editor methods
    private void OpenBodyEditor(string entityName, string scenarioName)
    {
        _modalEditingEntityName = entityName;
        _modalEditingScenarioName = scenarioName;
        _editingScenarioKey = $"{entityName}:{scenarioName}";
        _showBodyEditorModal = true;
    }

    private async Task OnModalEditorInit()
    {
        if (_modalBodyEditor != null &&
            _settings.CannedMessages.TryGetValue(_modalEditingEntityName, out var scenarios) &&
            scenarios.TryGetValue(_modalEditingScenarioName, out var msg) &&
            msg != null)
        {
            await _modalBodyEditor.SetValue(msg.Body ?? "{}");
        }
    }

    private StandaloneEditorConstructionOptions GetModalEditorConstructionOptions(StandaloneCodeEditor editor)
    {
        var contentType = "application/json";
        if (_settings.CannedMessages.TryGetValue(_modalEditingEntityName, out var scenarios) &&
            scenarios.TryGetValue(_modalEditingScenarioName, out var msg) &&
            msg != null)
        {
            contentType = msg.ContentType ?? "application/json";
        }

        return new StandaloneEditorConstructionOptions
        {
            Language = GetMonacoLanguage(contentType),
            Theme = "vs-dark",
            AutomaticLayout = true,
            Minimap = new EditorMinimapOptions { Enabled = false }
        };
    }

    private async Task SaveBodyEditorChanges()
    {
        if (_modalBodyEditor != null &&
            _settings.CannedMessages.TryGetValue(_modalEditingEntityName, out var scenarios) &&
            scenarios.TryGetValue(_modalEditingScenarioName, out var msg) &&
            msg != null)
        {
            msg.Body = await _modalBodyEditor.GetValue();
        }
        CloseBodyEditor();
    }

    private void CloseBodyEditor()
    {
        _showBodyEditorModal = false;
        _editingScenarioKey = string.Empty;
        _modalEditingEntityName = string.Empty;
        _modalEditingScenarioName = string.Empty;
    }

    private List<ApplicationPropertiesEditor.PropertyItem> GetAppPropertiesList(string entityName, string scenarioName)
    {
        var key = $"{entityName}:{scenarioName}";
        if (!_appPropsLists.ContainsKey(key))
        {
            _appPropsLists[key] = new List<ApplicationPropertiesEditor.PropertyItem>();
        }
        return _appPropsLists[key];
    }

    private List<BrokerPropertiesEditor.PropertyItem> GetBrokerPropertiesList(string entityName, string scenarioName)
    {
        var key = $"{entityName}:{scenarioName}";
        if (!_brokerPropsLists.ContainsKey(key))
        {
            _brokerPropsLists[key] = new List<BrokerPropertiesEditor.PropertyItem>();
        }
        return _brokerPropsLists[key];
    }

    private void SaveAppPropertiesFromList(string entityName, string scenarioName)
    {
        var key = $"{entityName}:{scenarioName}";
        if (_settings.CannedMessages.TryGetValue(entityName, out var scenarios) &&
            scenarios.TryGetValue(scenarioName, out var msg) &&
            msg != null &&
            _appPropsLists.TryGetValue(key, out var list))
        {
            msg.ApplicationProperties = list
                .Where(p => !string.IsNullOrWhiteSpace(p.Key))
                .ToDictionary(p => p.Key, p => (object)p.Value);
        }
    }

    private void SaveBrokerPropertiesFromList(string entityName, string scenarioName)
    {
        var key = $"{entityName}:{scenarioName}";
        if (_settings.CannedMessages.TryGetValue(entityName, out var scenarios) &&
            scenarios.TryGetValue(scenarioName, out var msg) &&
            msg != null &&
            _brokerPropsLists.TryGetValue(key, out var list))
        {
            msg.BrokerProperties = list
                .Where(p => !string.IsNullOrWhiteSpace(p.Key))
                .ToDictionary(p => p.Key, p => (object)p.Value);
        }
    }

    private void InitializeMessage(string entityName, string scenarioName)
    {
        if (_settings.CannedMessages.TryGetValue(entityName, out var scenarios) &&
            scenarios.TryGetValue(scenarioName, out var msg))
        {
            if (msg == null)
            {
                msg = new CannedMessage();
                scenarios[scenarioName] = msg;
            }

            msg.ContentType ??= _settings.DefaultContentType;
            msg.Body ??= "{}";
            msg.ApplicationProperties ??= new Dictionary<string, object>();
            msg.BrokerProperties ??= new Dictionary<string, object>();

            var key = $"{entityName}:{scenarioName}";
            _appPropsLists[key] = new List<ApplicationPropertiesEditor.PropertyItem>();
            _brokerPropsLists[key] = new List<BrokerPropertiesEditor.PropertyItem>();

            _message = "Message initialized successfully";
            StateHasChanged();
        }
    }

    private void ToggleScenarioDetails(string entityName, string scenarioName)
    {
        var key = $"{entityName}:{scenarioName}";
        if (_expandedScenarios.Contains(key))
        {
            _expandedScenarios.Remove(key);
        }
        else
        {
            // Ensure the message exists and is properly initialized before expanding
            if (_settings.CannedMessages.TryGetValue(entityName, out var scenarios) &&
                scenarios.TryGetValue(scenarioName, out var msg))
            {
                if (msg == null || msg.ContentType == null || msg.Body == null)
                {
                    _message = "Cannot show details: message data is missing or corrupted. Click Initialize to fix.";
                    StateHasChanged();
                    return;
                }
                
                // Ensure properties are initialized
                msg.ApplicationProperties ??= new Dictionary<string, object>();
                msg.BrokerProperties ??= new Dictionary<string, object>();
                
                // Ensure property lists exist
                if (!_appPropsLists.ContainsKey(key))
                {
                    _appPropsLists[key] = (msg.ApplicationProperties ?? new Dictionary<string, object>())
                        .Select(kv => new ApplicationPropertiesEditor.PropertyItem 
                        { 
                            Key = kv.Key, 
                            Value = kv.Value?.ToString() ?? string.Empty 
                        })
                        .ToList();
                }
                if (!_brokerPropsLists.ContainsKey(key))
                {
                    _brokerPropsLists[key] = (msg.BrokerProperties ?? new Dictionary<string, object>())
                        .Select(kv => new BrokerPropertiesEditor.PropertyItem 
                        { 
                            Key = kv.Key, 
                            Value = kv.Value?.ToString() ?? string.Empty 
                        })
                        .ToList();
                }
            }
            
            _expandedScenarios.Add(key);
        }
        
        StateHasChanged();
    }

    private void NavigateHome()
    {
        Navigation.NavigateTo("/");
    }

    private async Task SaveSettings()
    {
        // Save property lists back to the settings
        foreach (var entity in _settings.CannedMessages)
        {
            foreach (var scenario in entity.Value)
            {
                SaveAppPropertiesFromList(entity.Key, scenario.Key);
                SaveBrokerPropertiesFromList(entity.Key, scenario.Key);
            }
        }
        
        SettingsService.UpdateSettings(_settings);
        _message = "Settings saved successfully!";
        StateHasChanged();
        await Task.Delay(3000);
        _message = string.Empty;
        StateHasChanged();
    }

    private async Task ExportSettings()
    {
        // Save property lists before exporting
        foreach (var entity in _settings.CannedMessages)
        {
            foreach (var scenario in entity.Value)
            {
                SaveAppPropertiesFromList(entity.Key, scenario.Key);
                SaveBrokerPropertiesFromList(entity.Key, scenario.Key);
            }
        }
        
        // Export to JSON and open in new tab
        var json = SettingsService.ExportSettingsAsJson();
        var fileName = $"asb-emulator-settings-{DateTime.Now:yyyyMMdd-HHmmss}.json";
        await JSRuntime.InvokeVoidAsync("downloadJsonFile", json, fileName);
    }

    private async Task TriggerFileImport()
    {
        if (_fileInputComponent?.Element != null)
        {
            await JSRuntime.InvokeVoidAsync("triggerFileInput", _fileInputComponent.Element);
        }
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            if (file != null)
            {
                using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024); // 10MB max
                using var reader = new StreamReader(stream);
                var json = await reader.ReadToEndAsync();
                
                SettingsService.ImportSettingsFromJson(json);
                _settings = SettingsService.GetSettings();
                InitializePropertyLists();
                _message = "Settings imported successfully!";
            }
        }
        catch (Exception ex)
        {
            _message = $"Error importing settings: {ex.Message}";
        }
    }

    // Content Types
    private void AddContentType()
    {
        if (!string.IsNullOrWhiteSpace(_newContentType) && !_settings.ContentTypes.Contains(_newContentType))
        {
            _settings.ContentTypes.Add(_newContentType);
            _newContentType = string.Empty;
            StateHasChanged();
        }
    }

    private void RemoveContentType(int index)
    {
        if (index >= 0 && index < _settings.ContentTypes.Count)
        {
            _settings.ContentTypes.RemoveAt(index);
            StateHasChanged();
        }
    }

    // Common Properties
    private void AddCommonProperty()
    {
        if (!string.IsNullOrWhiteSpace(_newCommonPropKey))
        {
            _settings.CommonApplicationProperties.Add(new KeyValuePair<string, string>(_newCommonPropKey, _newCommonPropValue ?? string.Empty));
            _newCommonPropKey = string.Empty;
            _newCommonPropValue = string.Empty;
            StateHasChanged();
        }
    }

    private void RemoveCommonProperty(int index)
    {
        if (index >= 0 && index < _settings.CommonApplicationProperties.Count)
        {
            _settings.CommonApplicationProperties.RemoveAt(index);
            StateHasChanged();
        }
    }

    // Entities
    private void AddEntity()
    {
        if (!string.IsNullOrWhiteSpace(_newEntityName) && !_settings.CannedMessages.ContainsKey(_newEntityName))
        {
            _settings.CannedMessages[_newEntityName] = new Dictionary<string, CannedMessage>();
            _newScenarioNames[_newEntityName] = string.Empty;
            _newEntityName = string.Empty;
            StateHasChanged();
        }
    }

    private void RemoveEntity(string entityName)
    {
        _settings.CannedMessages.Remove(entityName);
        _newScenarioNames.Remove(entityName);
        
        // Clean up property lists cache
        var keysToRemove = _appPropsLists.Keys.Where(k => k.StartsWith($"{entityName}:")).ToList();
        foreach (var key in keysToRemove)
        {
            _appPropsLists.Remove(key);
            _brokerPropsLists.Remove(key);
        }
        
        StateHasChanged();
    }

    // Scenarios
    private void AddScenario(string entityName)
    {
        if (_newScenarioNames.TryGetValue(entityName, out var scenarioName) && 
            !string.IsNullOrWhiteSpace(scenarioName) && 
            _settings.CannedMessages.TryGetValue(entityName, out var scenarios) &&
            !scenarios.ContainsKey(scenarioName))
        {
            var newMsg = new CannedMessage
            {
                ContentType = _settings.DefaultContentType,
                Body = "{}",
                ApplicationProperties = new Dictionary<string, object>(),
                BrokerProperties = new Dictionary<string, object>()
            };
            
            scenarios[scenarioName] = newMsg;
            _newScenarioNames[entityName] = string.Empty;
            
            // Initialize empty property lists for the new scenario
            var key = $"{entityName}:{scenarioName}";
            _appPropsLists[key] = new List<ApplicationPropertiesEditor.PropertyItem>();
            _brokerPropsLists[key] = new List<BrokerPropertiesEditor.PropertyItem>();
            
            StateHasChanged();
        }
    }

    private void RemoveScenario(string entityName, string scenarioName)
    {
        if (_settings.CannedMessages.TryGetValue(entityName, out var scenarios))
        {
            scenarios.Remove(scenarioName);
            
            var key = $"{entityName}:{scenarioName}";
            _appPropsLists.Remove(key);
            _brokerPropsLists.Remove(key);
            _expandedScenarios.Remove(key);
            
            StateHasChanged();
        }
    }

    // Duplicate a scenario
    private void DuplicateScenario(string entityName, string scenarioName)
    {
        _duplicateEntityName = entityName;
        _duplicateSourceScenario = scenarioName;
        _duplicateNewName = $"{scenarioName} - Copy";
        _duplicateError = string.Empty;
        _showDuplicateDialog = true;
        StateHasChanged();
    }
    
    private void CancelDuplicate()
    {
        _showDuplicateDialog = false;
        _duplicateEntityName = string.Empty;
        _duplicateSourceScenario = string.Empty;
        _duplicateNewName = string.Empty;
        _duplicateError = string.Empty;
        StateHasChanged();
    }
    
    private async Task HandleDuplicateKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await ConfirmDuplicate();
        }
        else if (e.Key == "Escape")
        {
            CancelDuplicate();
        }
    }
    
    private async Task ConfirmDuplicate()
    {
        _duplicateError = string.Empty;
        
        if (string.IsNullOrWhiteSpace(_duplicateNewName))
        {
            _duplicateError = "Scenario name cannot be empty";
            StateHasChanged();
            return;
        }
        
        if (!_settings.CannedMessages.TryGetValue(_duplicateEntityName, out var scenarios))
        {
            _duplicateError = "Entity not found";
            StateHasChanged();
            return;
        }
        
        if (scenarios.ContainsKey(_duplicateNewName))
        {
            _duplicateError = $"Scenario '{_duplicateNewName}' already exists";
            StateHasChanged();
            return;
        }
        
        if (!scenarios.TryGetValue(_duplicateSourceScenario, out var sourceMessage) || sourceMessage == null)
        {
            _duplicateError = "Source scenario not found";
            StateHasChanged();
            return;
        }
        
        // Create a deep copy of the source message
        var duplicatedMessage = new CannedMessage
        {
            ContentType = sourceMessage.ContentType,
            Body = sourceMessage.Body,
            ApplicationProperties = sourceMessage.ApplicationProperties?
                .ToDictionary(kv => kv.Key, kv => kv.Value) ?? new Dictionary<string, object>(),
            BrokerProperties = sourceMessage.BrokerProperties?
                .ToDictionary(kv => kv.Key, kv => kv.Value) ?? new Dictionary<string, object>()
        };
        
        // Add the duplicated message
        scenarios[_duplicateNewName] = duplicatedMessage;
        
        // Initialize property lists for the new scenario
        var newKey = $"{_duplicateEntityName}:{_duplicateNewName}";
        _appPropsLists[newKey] = (duplicatedMessage.ApplicationProperties ?? new Dictionary<string, object>())
            .Select(kv => new ApplicationPropertiesEditor.PropertyItem 
            { 
                Key = kv.Key, 
                Value = kv.Value?.ToString() ?? string.Empty 
            })
            .ToList();
        
        _brokerPropsLists[newKey] = (duplicatedMessage.BrokerProperties ?? new Dictionary<string, object>())
            .Select(kv => new BrokerPropertiesEditor.PropertyItem 
            { 
                Key = kv.Key, 
                Value = kv.Value?.ToString() ?? string.Empty 
            })
            .ToList();
        
        _message = $"Duplicated '{_duplicateSourceScenario}' to '{_duplicateNewName}'";
        
        // Close dialog
        CancelDuplicate();
        
        // Expand the new scenario
        _expandedScenarios.Add(newKey);
        
        StateHasChanged();
    }

    // Helper for mapping content types to Monaco languages
    private string GetMonacoLanguage(string contentType)
    {
        return contentType switch
        {
            "application/json" => "json",
            "application/xml" => "xml",
            "text/plain" => "plaintext",
            _ => "plaintext",
        };
    }
}