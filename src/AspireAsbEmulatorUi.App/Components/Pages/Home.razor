@page "/"
@rendermode InteractiveServer
@implements IDisposable
@using System.Threading
@inject AspireAsbEmulatorUi.App.Services.AsbEmulatorSqlEntityRepository Repo
@inject AspireAsbEmulatorUi.App.Services.ServiceBusService Bus
@inject Microsoft.Extensions.Configuration.IConfiguration Configuration
@inject NavigationManager Navigation

<PageTitle>Home</PageTitle>

<main class="min-h-screen max-w-screen-2xl mx-auto p-6 flex flex-col">
    <div class="flex items-center justify-between mb-4">
        <h1 class="text-2xl font-semibold">ASB Emulator Explorer</h1>
        <button class="px-3 py-2 rounded bg-slate-700 text-slate-100 hover:bg-slate-600 flex items-center gap-2" @onclick="NavigateToSettings" title="Settings">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
            </svg>
            <span class="text-sm">Settings</span>
        </button>
    </div>

    <div class="flex-1 grid grid-cols-12 gap-6 min-h-0">
        <!-- Left pane - Entities List -->
        <div class="col-span-5 flex flex-col bg-slate-800 rounded-lg border border-slate-700 overflow-hidden">
            <div class="p-4 border-b border-slate-700 bg-slate-850">
                <div class="flex items-center gap-3 mb-4">
                    <label class="text-sm text-slate-300 font-medium">Filter</label>
                    <div class="relative flex-1">
                        <input @bind="_filter" @bind:event="oninput" @bind:after="OnFilterChanged" placeholder="search by name or id" class="bg-slate-900 border border-slate-600 text-slate-100 px-3 py-1 rounded w-full pr-8" />
                        @if (!string.IsNullOrWhiteSpace(_filter))
                        {
                            <button @onclick="ClearFilter" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-200" title="Clear filter">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        }
                    </div>
                </div>

                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <span class="text-sm text-slate-300 font-medium">Refresh</span>
                        <div class="flex rounded bg-slate-700 p-1 items-center">
                            <button class=@($"px-3 py-1 rounded-l text-sm {(_autoRefreshEnabled ? "bg-slate-600 text-white" : "text-slate-200 hover:bg-slate-600")}") title="Auto refresh every 2 seconds for 5 minutes." @onclick="async () => await SetAutoRefresh(true)">Auto</button>
                            <button class=@($"px-3 py-1 text-sm {(!_autoRefreshEnabled ? "bg-slate-600 text-white" : "text-slate-200 hover:bg-slate-600")}") title="Disable Auto refresh" @onclick="async () => await SetAutoRefresh(false)">Manual</button>
                            @if (!_autoRefreshEnabled)
                            {
                                <button title="Refresh Entities now!" class="ml-2 px-3 py-1 rounded bg-blue-600 text-white flex items-center gap-2 hover:bg-blue-700" @onclick="Refresh">
                                    <span class="text-sm">Now!</span>
                                </button>
                            }
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="text-xs text-slate-400 flex items-center gap-1" title="Last refresh time">
                            @if (_loading)
                            {
                                <svg class="animate-spin h-3 w-3 text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <span class="text-blue-400">Refreshing...</span>
                            }
                            else
                            {
                                <span>@@ @(_lastRefreshed.HasValue ? _lastRefreshed.Value.ToString("yyyy-MM-dd HH:mm:ss") : "Never")</span>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-4 space-y-6">
                <!-- Queues Section -->
                <div>
                    <h3 class="text-lg font-semibold mb-3 text-slate-200 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                        Queues
                    </h3>
                    <div class="space-y-2">
                        @{
                            var queues = _entities.Where(e => string.Equals(e.EntityType, "Queue", StringComparison.OrdinalIgnoreCase) && EvaluateFilter(e)).ToList();
                        }
                        @if (!queues.Any() && !_loading)
                        {
                            <div class="bg-slate-900 rounded p-3 text-slate-400 text-sm border border-slate-700">No queues found.</div>
                        }
                        else
                        {
                            @foreach (var e in queues)
                            {
                                var isSelected = _selectedEntity == e.Name;
                                var cardClass = isSelected 
                                    ? "p-3 rounded cursor-pointer border-2 border-blue-500 bg-slate-700 hover:bg-slate-600 transition-colors" 
                                    : "p-3 rounded cursor-pointer border border-slate-600 bg-slate-900 hover:bg-slate-700 transition-colors";
                                
                                <div class="@cardClass" @onclick="@(() => SelectEntity(e))">
                                    <div class="flex items-center justify-between">
                                        <div class="font-medium text-slate-100">@e.DisplayName</div>
                                        <div class="flex items-center gap-2">
                                            <div class="text-xs px-2 py-1 rounded bg-slate-800 border border-slate-700 text-slate-300" title="Active messages">
                                                <span class="text-slate-400">Active:</span> <span class="font-semibold text-green-400">@e.ActiveMessageCount</span>
                                            </div>
                                            <div class="text-xs px-2 py-1 rounded bg-slate-800 border border-slate-700 text-slate-300" title="Dead-letter queue messages">
                                                <span class="text-slate-400">DLQ:</span> <span class="font-semibold text-red-400">@e.DeadletterMessageCount</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>

                <!-- Topics Section (with subscriptions as children) -->
                <div>
                    <h3 class="text-lg font-semibold mb-3 text-slate-200 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                        Topics
                    </h3>
                    <div class="space-y-2">
                        @{
                            var topics = _entities.Where(e => string.Equals(e.EntityType, "Topic", StringComparison.OrdinalIgnoreCase) && EvaluateFilter(e)).ToList();
                        }
                        @if (!topics.Any() && !_loading)
                        {
                            <div class="bg-slate-900 rounded p-3 text-slate-400 text-sm border border-slate-700">No topics found.</div>
                        }
                        else
                        {
                            @foreach (var topic in topics)
                            {
                                var isTopicSelected = _selectedEntity == topic.Name;
                                var topicCardClass = isTopicSelected 
                                    ? "p-3 rounded cursor-pointer border-2 border-blue-500 bg-slate-700 hover:bg-slate-600 transition-colors" 
                                    : "p-3 rounded cursor-pointer border border-slate-600 bg-slate-900 hover:bg-slate-700 transition-colors";
                                
                                <div class="@topicCardClass" @onclick="@(() => SelectEntity(topic))">
                                    <div class="flex items-center justify-between">
                                        <div class="font-medium text-slate-100">@topic.DisplayName</div>
                                        <div class="flex items-center gap-2">
                                            <div class="text-xs px-2 py-1 rounded bg-slate-800 border border-slate-700 text-slate-300" title="Active messages">
                                                <span class="text-slate-400">Active:</span> <span class="font-semibold text-green-400">@topic.ActiveMessageCount</span>
                                            </div>
                                            <div class="text-xs px-2 py-1 rounded bg-slate-800 border border-slate-700 text-slate-300" title="Dead-letter queue messages">
                                                <span class="text-slate-400">DLQ:</span> <span class="font-semibold text-red-400">@topic.DeadletterMessageCount</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                @* Render subscriptions for this topic *@
                                var subs = _entities.Where(e => e.EntityType == "Subscription" && e.ParentTopic == topic.Name && EvaluateFilter(e)).ToList();
                                @if (subs.Any())
                                {
                                    <div class="ml-6 space-y-1 mt-1">
                                        @foreach (var sub in subs)
                                        {
                                            var isSubSelected = _selectedEntity == sub.Name;
                                            var subCardClass = isSubSelected
                                                ? "p-2 rounded cursor-pointer border-2 border-blue-500 bg-slate-700 hover:bg-slate-600 transition-colors"
                                                : "p-2 rounded cursor-pointer border border-slate-600 bg-slate-900 hover:bg-slate-700 transition-colors";

                                            <div class="@subCardClass" @onclick="@(() => SelectEntity(sub))">
                                                <div class="flex items-center justify-between">
                                                    <div class="flex items-center gap-2">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-purple-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                                        </svg>
                                                        <span class="text-sm font-medium text-slate-200">@sub.DisplayName</span>
                                                    </div>
                                                    <div class="flex items-center gap-2">
                                                        <div class="text-xs px-2 py-0.5 rounded bg-slate-800 border border-slate-700 text-slate-300" title="Active messages">
                                                            <span class="text-slate-400">Active:</span> <span class="font-semibold text-green-400">@sub.ActiveMessageCount</span>
                                                        </div>
                                                        <div class="text-xs px-2 py-0.5 rounded bg-slate-800 border border-slate-700 text-slate-300" title="Dead-letter queue messages">
                                                            <span class="text-slate-400">DLQ:</span> <span class="font-semibold text-red-400">@sub.DeadletterMessageCount</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                            }
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Right pane - Message Viewer/Sender -->
        <div class="col-span-7 flex flex-col bg-slate-800 rounded-lg border border-slate-700 overflow-hidden">
            @if (string.IsNullOrEmpty(_selectedEntity))
            {
                <div class="flex-1 flex items-center justify-center p-8">
                    <div class="text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
                        </svg>
                        <p class="text-slate-400 text-lg mb-2">Select an entity</p>
                        <p class="text-slate-500 text-sm">Choose a queue, topic, or subscription from the left panel.</p>
                    </div>
                </div>
            }
            else
            {
                <div class="p-3 border-b border-slate-700 bg-slate-850">
                    <nav class="flex gap-2">
                        <button 
                            class=@($"px-4 py-2 rounded font-semibold transition-colors border {(_activeTab == "viewer" ? "border-2 border-blue-500 bg-slate-700 text-white shadow-md" : "border border-slate-700 bg-slate-800 text-slate-300 hover:bg-slate-700")}")
                            @onclick="ShowViewer">
                            <span class="flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                                Viewer
                            </span>
                        </button>
                        <button 
                            class=@($"px-4 py-2 rounded font-semibold transition-colors border {(_activeTab == "sender" ? "border-2 border-blue-500 bg-slate-700 text-white shadow-md" : (_selectedEntityType == "Subscription" ? "border border-slate-700 bg-slate-800 text-slate-500 cursor-not-allowed" : "border border-slate-700 bg-slate-800 text-slate-300 hover:bg-slate-700"))}")
                            @onclick="ShowSender"
                            disabled="@(_selectedEntityType == "Subscription")"
                            title="@(_selectedEntityType == "Subscription" ? "Cannot send to subscriptions - send to the parent topic instead" : "")">
                            <span class="flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                                </svg>
                                Send
                                @if (_selectedEntityType == "Subscription")
                                {
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                                    </svg>
                                }
                            </span>
                        </button>
                    </nav>
                </div>

                <div class="flex-1 overflow-y-auto p-4">
                    @if (_activeTab == "viewer")
                    {
                        <MessageViewer SelectedEntity="@_selectedEntity" DisplayName="@_selectedDisplayName" OnEntityChanged="RefreshEntities" />
                    }
                    else if (_activeTab == "sender")
                    {
                        <MessageSender SelectedEntity="@_selectedEntity" DisplayName="@_selectedDisplayName" OnEntityChanged="RefreshEntities" />
                    }
                </div>
            }
        </div>
    </div>
</main>

@code{
    private bool _loading = false;
    private List<Models.ServiceBusEntityInfo> _entities = new();

    private string _selectedEntity = string.Empty;
    private string _selectedDisplayName = string.Empty;
    private string _selectedEntityType = string.Empty;

    private string _sendBody = string.Empty;
    private string _sendResult = string.Empty;

    private string _filter = string.Empty;
    private System.Threading.Timer? _filterDebounceTimer;

    private string _activeTab = "viewer";

    private bool _autoRefreshEnabled = false;
    private DateTime? _lastRefreshed;

    private System.Threading.Timer? _autoRefreshTimer;

    protected override async Task OnInitializedAsync()
    {
        await Refresh();
    }

    private async Task Refresh()
    {
        _loading = true;
        StateHasChanged(); // Ensure UI updates immediately to show spinner
        
        try
        {
            var entities = await Repo.GetEntitiesAsync();
            _entities = await Bus.EnrichEntitiesWithMessageCountsAsync(entities);
            _lastRefreshed = DateTime.Now;
        }
        catch (Exception ex)
        {
            _entities = new List<Models.ServiceBusEntityInfo>();
            _sendResult = ex.Message;
        }
        finally
        {
            _loading = false;
            StateHasChanged(); // Ensure UI updates to hide spinner
        }
    }

    private async Task RefreshEntities()
    {
        await Refresh();
        StateHasChanged();
    }

    private void OnFilterChanged()
    {
        // Cancel any existing timer
        _filterDebounceTimer?.Dispose();
        
        // Start a new timer that will trigger filtering after 3 seconds
        _filterDebounceTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(() =>
            {
                StateHasChanged();
            });
        }, null, TimeSpan.FromSeconds(3), Timeout.InfiniteTimeSpan);
    }

    private void ClearFilter()
    {
        _filter = string.Empty;
        _filterDebounceTimer?.Dispose();
        StateHasChanged();
    }

    private void ApplyFilter()
    {
        StateHasChanged();
    }

    private bool EvaluateFilter(Models.ServiceBusEntityInfo e)
    {
        if (string.IsNullOrWhiteSpace(_filter)) return true;
        if (e.Name.Contains(_filter, StringComparison.OrdinalIgnoreCase)) return true;
        if (e.DisplayName.Contains(_filter, StringComparison.OrdinalIgnoreCase)) return true;
        if (long.TryParse(_filter, out var id) && e.Id == id) return true;
        return false;
    }

    private void SelectEntity(Models.ServiceBusEntityInfo e)
    {
        _selectedEntity = e.Name;
        _selectedDisplayName = e.DisplayName;
        _selectedEntityType = e.EntityType;
        _sendResult = string.Empty;
        
        // Auto-switch tabs based on entity type
        if (e.EntityType == "Subscription")
        {
            // Subscriptions can only view
            _activeTab = "viewer";
        }
        else if (e.EntityType == "Topic")
        {
            // Topics can only send
            _activeTab = "sender";
        }
    }

    private void NavigateToSettings()
    {
        Navigation.NavigateTo("/settings");
    }

    private void ShowViewer()
    {
        // Don't allow switching to viewer for Topics
        if (_selectedEntityType != "Topic")
        {
            _activeTab = "viewer";
        }
    }

    private void ShowSender()
    {
        // Don't allow switching to sender for subscriptions
        if (_selectedEntityType != "Subscription")
        {
            _activeTab = "sender";
        }
    }

    private Task OnAutoRefreshChanged(ChangeEventArgs e)
    {
        // parse checkbox value
        var isChecked = false;
        if (e?.Value is bool b) isChecked = b;
        else if (e?.Value is string s) isChecked = s.Equals("true", StringComparison.OrdinalIgnoreCase) || s.Equals("on", StringComparison.OrdinalIgnoreCase);

        _autoRefreshEnabled = isChecked;

        if (_autoRefreshEnabled)
        {
            _autoRefreshTimer?.Dispose();
            var end = DateTime.UtcNow + TimeSpan.FromMinutes(5);
            _autoRefreshTimer = new System.Threading.Timer(async _ =>
            {
                if (DateTime.UtcNow >= end)
                {
                    _autoRefreshTimer?.Dispose();
                    _autoRefreshTimer = null;
                    _autoRefreshEnabled = false;
                    await InvokeAsync(StateHasChanged);
                    return;
                }

                try
                {
                    await InvokeAsync(async () =>
                    {
                        await Refresh();
                    });
                }
                catch { }
            }, null, TimeSpan.Zero, TimeSpan.FromSeconds(2));
        }
        else
        {
            _autoRefreshTimer?.Dispose();
            _autoRefreshTimer = null;
        }

        return Task.CompletedTask;
    }

    private Task SetAutoRefresh(bool enable)
    {
        // forward to existing handler using a synthetic ChangeEventArgs
        return OnAutoRefreshChanged(new ChangeEventArgs { Value = enable });
    }

    public void Dispose()
    {
        _filterDebounceTimer?.Dispose();
        _autoRefreshTimer?.Dispose();
    }
}
