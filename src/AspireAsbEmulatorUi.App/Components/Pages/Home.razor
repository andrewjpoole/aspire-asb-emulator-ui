@page "/"
@rendermode InteractiveServer
@using System.Threading
@inject AspireAsbEmulatorUi.App.Services.AsbEmulatorSqlEntityRepository Repo
@inject AspireAsbEmulatorUi.App.Services.ServiceBusService Bus
@inject Microsoft.Extensions.Configuration.IConfiguration Configuration

<PageTitle>Home</PageTitle>

<main class="max-w-screen-2xl mx-auto p-6">
    <div class="flex items-center justify-between mb-4">
        <h1 class="text-2xl font-semibold">ASB Emulator Explorer</h1>
    </div>

    <div class="flex items-center gap-3 mb-4">
        <label class="text-sm text-slate-300">Filter</label>
        <input @bind="_filter" placeholder="search by name or id" class="bg-slate-800 border border-slate-700 text-slate-100 px-3 py-1 rounded w-64" />
        <button class="px-3 py-1 rounded border border-slate-700 text-slate-100 hover:bg-slate-700" @onclick="ApplyFilter">Apply</button>
    </div>

    <div class="grid grid-cols-12 gap-6">
        <!-- Left pane -->
        <div class="col-span-5 space-y-4">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-3">
                    <span class="text-sm">Refresh</span>
                    <div class="flex rounded bg-slate-700 p-1">
                        <button class=@($"px-3 py-1 rounded-l text-sm {(_autoRefreshEnabled ? "bg-blue-600 text-white" : "text-slate-200")}") title="Auto refresh every 2 seconds for 5 minutes." @onclick="async () => await SetAutoRefresh(true)">Auto</button>
                        <button class=@($"px-3 py-1 rounded-r text-sm {(!_autoRefreshEnabled ? "bg-blue-600 text-white" : "text-slate-200")}") title="Disable Auto refresh" @onclick="async () => await SetAutoRefresh(false)">Manual</button>
                    </div>

                    <button title="Refresh Entities now!" class=@($"px-3 py-1 rounded bg-blue-600 text-white flex items-center gap-2 {(_autoRefreshEnabled ? "opacity-50 cursor-not-allowed" : "hover:bg-blue-700")}") @onclick="Refresh" disabled="@_autoRefreshEnabled">
                        <span class="text-sm">Now!</span>
                    </button>

                    <div class="text-xs text-slate-400" title="Last refresh time">@@ @(_lastRefreshed.HasValue ? _lastRefreshed.Value.ToString("yyyy-MM-dd HH:mm:ss") : "Never")</div>
                </div>
            </div>

            <div class="flex items-center justify-between">
                <h3 class="text-lg font-medium">Queues</h3>
            </div>

            <div class="space-y-3 max-h-[60vh] overflow-auto pr-2">
                @if (_loading)
                {
                    <div class="text-sm text-slate-400">Loading...</div>
                }
                else
                {
                    var queues = _entities.Where(e => string.Equals(e.EntityType, "Queue", StringComparison.OrdinalIgnoreCase) && EvaluateFilter(e)).ToList();
                    if (!queues.Any())
                    {
                        <div class="bg-slate-800 rounded p-3 text-slate-400">No queues.</div>
                    }
                    else
                    {
                        foreach (var e in queues)
                        {
                            var isSelected = _selectedEntity == e.Name;
                            var cardClass = isSelected 
                                ? "p-3 rounded cursor-pointer border-2 border-blue-500 bg-slate-700" 
                                : "p-3 rounded cursor-pointer border border-slate-700 bg-slate-800 hover:bg-slate-700";
                            
                            <div class="@cardClass" @onclick="@(() => SelectEntity(e))">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="font-semibold">@e.DisplayName</div>
                                        <div class="text-sm text-slate-400">Id: @e.Id</div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="text-sm px-2 py-0.5 rounded bg-slate-700" title="ASB emulator SQL entityLookup table is quite slow to refresh message counts, typically ~15 seconds!">Active: @e.ActiveMessageCount</div>
                                        <div class="text-sm px-2 py-0.5 rounded bg-slate-700" title="ASB emulator SQL entityLookup table is quite slow to refresh message counts, typically ~15 seconds!">DLQ: @e.DeadletterMessageCount</div>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                }
            </div>

            <div>
                <h3 class="text-lg font-medium mb-2">Topics</h3>
                <div class="space-y-3 max-h-[60vh] overflow-auto pr-2">
                    @if (_loading)
                    {
                        <div class="text-sm text-slate-400">Loading...</div>
                    }
                    else
                    {
                        var topics = _entities.Where(e => string.Equals(e.EntityType, "Topic", StringComparison.OrdinalIgnoreCase) && EvaluateFilter(e)).ToList();
                        if (!topics.Any())
                        {
                            <div class="bg-slate-800 rounded p-3 text-slate-400">No topics.</div>
                        }
                        else
                        {
                            foreach (var e in topics)
                            {
                                var isSelected = _selectedEntity == e.Name;
                                var cardClass = isSelected 
                                    ? "p-3 rounded cursor-pointer border-2 border-blue-500 bg-slate-700" 
                                    : "p-3 rounded cursor-pointer border border-slate-700 bg-slate-800 hover:bg-slate-700";
                                
                                <div class="@cardClass" @onclick="@(() => SelectEntity(e))">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="font-semibold">@e.DisplayName</div>
                                            <div class="text-sm text-slate-400">Id: @e.Id</div>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <div class="text-sm px-2 py-0.5 rounded bg-slate-700">Active: @e.ActiveMessageCount</div>
                                            <div class="text-sm px-2 py-0.5 rounded bg-slate-700">DLQ: @e.DeadletterMessageCount</div>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    }
                </div>
            </div>
        </div>

        <!-- Right pane (tabbed) -->
        <div class="col-span-7">
            @if (string.IsNullOrEmpty(_selectedEntity))
            {
                <div class="bg-slate-800 rounded p-4 text-slate-400">Select an entity on the left to view messages or send.</div>
            }
            else
            {
                <div class="bg-slate-800 rounded p-2 mb-4">
                    <nav class="flex gap-2">
                        <button class=@($"px-3 py-1 rounded {(_activeTab == "viewer" ? "bg-blue-600 text-white" : "bg-slate-700 text-slate-200")}") @onclick="ShowViewer">Viewer</button>
                        <button class=@($"px-3 py-1 rounded {(_activeTab == "sender" ? "bg-blue-600 text-white" : "bg-slate-700 text-slate-200")}") @onclick="ShowSender">Send</button>
                    </nav>
                </div>

                <div>
                    @if (_activeTab == "viewer")
                    {
                        <MessageViewer SelectedEntity="@_selectedEntity" DisplayName="@_selectedDisplayName" />
                    }
                    else
                    {
                        <MessageSender SelectedEntity="@_selectedEntity" DisplayName="@_selectedDisplayName" />
                    }
                </div>
            }
        </div>
    </div>
</main>

@code{
    private bool _loading = false;
    private List<Models.ServiceBusEntityInfo> _entities = new();

    private string _selectedEntity = string.Empty;
    private string _selectedDisplayName = string.Empty;
    private bool _isDlqSelected = false;
    private List<string>? _messages;

    private string _sendBody = string.Empty;
    private string _sendResult = string.Empty;

    private string _filter = string.Empty;
    private string _peekOrReceive = "peek";
    private int _maxMessages = 20;

    private string _activeTab = "viewer";

    private bool _autoRefreshEnabled = false;
    private CancellationTokenSource? _autoRefreshCts;
    private DateTime? _lastRefreshed;

    private System.Threading.Timer? _autoRefreshTimer;

    protected override async Task OnInitializedAsync()
    {
        await Refresh();
    }

    private async Task Refresh()
    {
        _loading = true;
        try
        {
            _entities = await Repo.GetEntitiesAsync();
            _lastRefreshed = DateTime.Now;
        }
        catch (Exception ex)
        {
            _entities = new List<Models.ServiceBusEntityInfo>();
            _sendResult = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private void ApplyFilter()
    {
        StateHasChanged();
    }

    private bool EvaluateFilter(Models.ServiceBusEntityInfo e)
    {
        if (string.IsNullOrWhiteSpace(_filter)) return true;
        if (e.Name.Contains(_filter, StringComparison.OrdinalIgnoreCase)) return true;
        if (e.DisplayName.Contains(_filter, StringComparison.OrdinalIgnoreCase)) return true;
        if (long.TryParse(_filter, out var id) && e.Id == id) return true;
        return false;
    }

    private void SelectEntity(Models.ServiceBusEntityInfo e)
    {
        _selectedEntity = e.Name;
        _selectedDisplayName = e.DisplayName;
        _isDlqSelected = false;
        _messages = null;
        _sendResult = string.Empty;
    }

    private void OnTargetChanged(ChangeEventArgs e)
    {
        var val = e?.Value?.ToString();
        if (string.IsNullOrWhiteSpace(val))
        {
            _selectedEntity = string.Empty;
            _selectedDisplayName = string.Empty;
            return;
        }

        _selectedEntity = val;
        _selectedDisplayName = _entities.FirstOrDefault(x => x.Name == val)?.DisplayName ?? val;
        _isDlqSelected = false;
        _messages = null;
        _sendResult = string.Empty;
    }

    private void OpenViewer(string name, bool dlq)
    {
        _selectedEntity = name;
        _selectedDisplayName = _entities.FirstOrDefault(x => x.Name == name)?.DisplayName ?? name;
        _isDlqSelected = dlq;
        _messages = null;
        _activeTab = "viewer";
    }

    private void ShowViewer()
    {
        _activeTab = "viewer";
    }

    private void ShowSender()
    {
        _activeTab = "sender";
    }

    private Task OnAutoRefreshChanged(ChangeEventArgs e)
    {
        // parse checkbox value
        var isChecked = false;
        if (e?.Value is bool b) isChecked = b;
        else if (e?.Value is string s) isChecked = s.Equals("true", StringComparison.OrdinalIgnoreCase) || s.Equals("on", StringComparison.OrdinalIgnoreCase);

        _autoRefreshEnabled = isChecked;

        if (_autoRefreshEnabled)
        {
            _autoRefreshTimer?.Dispose();
            var end = DateTime.UtcNow + TimeSpan.FromMinutes(5);
            _autoRefreshTimer = new System.Threading.Timer(async _ =>
            {
                if (DateTime.UtcNow >= end)
                {
                    _autoRefreshTimer?.Dispose();
                    _autoRefreshTimer = null;
                    _autoRefreshEnabled = false;
                    await InvokeAsync(StateHasChanged);
                    return;
                }

                try
                {
                    await InvokeAsync(async () =>
                    {
                        await Refresh();
                        StateHasChanged();
                    });
                }
                catch { }
            }, null, TimeSpan.Zero, TimeSpan.FromSeconds(2));
        }
        else
        {
            _autoRefreshTimer?.Dispose();
            _autoRefreshTimer = null;
        }

        return Task.CompletedTask;
    }

    private Task SetAutoRefresh(bool enable)
    {
        // forward to existing handler using a synthetic ChangeEventArgs
        return OnAutoRefreshChanged(new ChangeEventArgs { Value = enable });
    }

    public void Dispose()
    {
        _autoRefreshCts?.Cancel();
    }
}
