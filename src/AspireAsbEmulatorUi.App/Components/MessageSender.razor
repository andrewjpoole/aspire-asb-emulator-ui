@using AspireAsbEmulatorUi.App.Services
@using AspireAsbEmulatorUi.App.Models
@using BlazorMonaco
@using BlazorMonaco.Editor
@inject ServiceBusService Bus
@inject SettingsService SettingsService
@inject PlaceholderService PlaceholderService

<div>
    <h3 class="text-lg font-medium mb-2">Send Message to @DisplayName</h3>    

    <div class="mb-3">
        <HandyClipboardValues />
    </div>

    <label class="text-sm text-slate-400 block mb-1">Content type</label>
    <div class="mb-3">
        <select @bind="_contentType" @bind:after="OnContentTypeChanged" class="bg-slate-800 border border-slate-700 text-slate-100 px-3 py-1 rounded w-64">
            <option value="application/json">application/json</option>
            <option value="text/plain">text/plain</option>
            <option value="application/octet-stream">application/octet-stream</option>
            <option value="application/xml">application/xml</option>
        </select>
    </div>

    <label class="text-sm text-slate-400 block mb-1">Body (text)</label>
    <div class="border border-slate-700 rounded overflow-hidden" style="height: 250px; width: 100%;">
        <StandaloneCodeEditor 
            @ref="_editor" 
            Id="message-body-editor"
            CssClass="h-full w-full"
            ConstructionOptions="EditorConstructionOptions"
            OnDidInit="OnEditorInit" />
    </div>

    <div class="mt-4 space-y-4">
        <BrokerPropertiesEditor 
            Title="Broker properties"
            Properties="_brokerProperties"
            OnPropertiesChanged="StateHasChanged"
            OnMessage="@((msg) => { _result = msg; StateHasChanged(); })" />

        <ApplicationPropertiesEditor 
            Title="Application properties"
            Properties="_appProperties"
            OnPropertiesChanged="StateHasChanged" />
    </div>

    <div class="mt-6 pt-4 border-t border-slate-700 flex gap-2">
        <button class="px-3 py-1 rounded bg-blue-600 text-white hover:bg-blue-700" @onclick="ConfirmAndSend">Send Message</button>
        <button class="px-3 py-1 rounded bg-slate-600 text-white hover:bg-slate-700" @onclick="SaveAsCannedMessage">Save as Canned Message</button>
        @if (!string.IsNullOrEmpty(_result))
        {
            <div class="text-sm text-slate-400 mt-2">@_result</div>
        }
    </div>

    @if (_confirmEmpty)
    {
        <div class="mt-3 rounded p-3 bg-yellow-800 text-yellow-100">
            Warning: you are sending an empty message body. This action may be intentional.
            <div class="mt-2 flex gap-2">
                <button class="px-3 py-1 rounded bg-red-600 text-white" @onclick="Send">Proceed</button>
                <button class="px-3 py-1 rounded bg-slate-700 text-white" @onclick="() => _confirmEmpty = false">Cancel</button>
            </div>
        </div>
    }

    @if (_showSaveDialog)
    {
        <div class="mt-3 rounded p-3 bg-slate-700 border border-slate-600">
            <h4 class="font-semibold mb-2">Save as Canned Message</h4>
            <div class="space-y-2">
                <div>
                    <label class="text-xs text-slate-400 block mb-1">Entity Name</label>
                    <input class="w-full bg-slate-900 border border-slate-700 text-slate-100 px-2 py-1 rounded text-sm" 
                           @bind="_cannedEntityName" 
                           placeholder="e.g., myqueue or mytopic" />
                </div>
                <div>
                    <label class="text-xs text-slate-400 block mb-1">Scenario Name</label>
                    <input class="w-full bg-slate-900 border border-slate-700 text-slate-100 px-2 py-1 rounded text-sm" 
                           @bind="_cannedScenarioName" 
                           placeholder="e.g., test scenario" />
                </div>
                <div class="flex gap-2 mt-3">
                    <button class="px-3 py-1 rounded bg-blue-600 text-white hover:bg-blue-700 text-sm" @onclick="SaveCannedMessage">Save</button>
                    <button class="px-3 py-1 rounded bg-slate-600 text-white hover:bg-slate-500 text-sm" @onclick="() => _showSaveDialog = false">Cancel</button>
                </div>
            </div>
        </div>
    }
</div>

@code{
    [Parameter] public string SelectedEntity { get; set; } = string.Empty;
    [Parameter] public string DisplayName { get; set; } = string.Empty;

    private StandaloneCodeEditor? _editor;
    private string _body = string.Empty;
    private string _result = string.Empty;

    private string _contentType = "application/json";

    private List<BrokerPropertiesEditor.PropertyItem> _brokerProperties = new();
    private List<ApplicationPropertiesEditor.PropertyItem> _appProperties = new();

    private bool _confirmEmpty = false;
    private bool _showSaveDialog = false;
    private string _cannedEntityName = string.Empty;
    private string _cannedScenarioName = string.Empty;

    private StandaloneEditorConstructionOptions EditorConstructionOptions(StandaloneCodeEditor editor)
    {
        return new StandaloneEditorConstructionOptions
        {
            AutomaticLayout = true,
            Language = GetMonacoLanguage(_contentType),
            Theme = "vs-dark",
            Value = _body,
            Minimap = new EditorMinimapOptions { Enabled = false },
            ScrollBeyondLastLine = false,
            FontSize = 13,
            TabSize = 2
        };
    }

    private async Task OnEditorInit()
    {
        if (_editor != null)
        {
            await _editor.SetValue(_body);
        }
    }

    private async Task OnContentTypeChanged()
    {
        if (_editor != null)
        {
            var model = await _editor.GetModel();
            await Global.SetModelLanguage(model, GetMonacoLanguage(_contentType));
        }
    }

    private string GetMonacoLanguage(string contentType)
    {
        return contentType switch
        {
            "application/json" => "json",
            "application/xml" => "xml",
            "text/plain" => "plaintext",
            _ => "plaintext"
        };
    }

    private async Task ConfirmAndSend()
    {
        // Get the current value from the editor first
        if (_editor != null)
        {
            _body = await _editor.GetValue();
        }

        if (string.IsNullOrWhiteSpace(_body))
        {
            _confirmEmpty = true;
            return;
        }
        
        await Send();
    }

    private async Task Send()
    {
        _confirmEmpty = false;

        if (string.IsNullOrWhiteSpace(SelectedEntity))
        {
            _result = "Select a target entity first.";
            return;
        }

        try
        {
            // Get the current value from the editor
            if (_editor != null)
            {
                _body = await _editor.GetValue();
            }

            var ct = _contentType;

            var appProps = _appProperties
                .Where(kv => !string.IsNullOrWhiteSpace(kv.Key))
                .ToDictionary(k => k.Key, v => (object?)v.Value);
            
            var brokerProps = _brokerProperties
                .Where(kv => !string.IsNullOrWhiteSpace(kv.Key))
                .ToDictionary(k => k.Key, v => (object?)v.Value);

            if (!string.IsNullOrWhiteSpace(ct)) brokerProps["ContentType"] = ct;

            await Bus.SendMessageAsync(SelectedEntity, _body, appProps, brokerProps);
            _result = $"Sent at {DateTime.Now:HH:mm:ss}";
            
            // Clear the editor and properties
            if (_editor != null)
            {
                await _editor.SetValue(string.Empty);
            }
            _body = string.Empty;
            
            // Clear property lists
            _appProperties.Clear();
            _brokerProperties.Clear();
        }
        catch (Exception ex)
        {
            _result = $"Error: {ex.Message}";
        }
    }

    private void SaveAsCannedMessage()
    {
        _cannedEntityName = SelectedEntity;
        _showSaveDialog = true;
    }

    private async Task SaveCannedMessage()
    {
        if (string.IsNullOrWhiteSpace(_cannedEntityName) || string.IsNullOrWhiteSpace(_cannedScenarioName))
        {
            _result = "Please provide both entity and scenario names";
            _showSaveDialog = false;
            return;
        }

        try
        {
            // Get current editor value
            if (_editor != null)
            {
                _body = await _editor.GetValue();
            }

            var settings = SettingsService.GetSettings();
            
            // Ensure entity exists
            if (!settings.CannedMessages.ContainsKey(_cannedEntityName))
            {
                settings.CannedMessages[_cannedEntityName] = new Dictionary<string, CannedMessage>();
            }

            // Create the canned message
            var cannedMessage = new CannedMessage
            {
                ContentType = _contentType,
                Body = _body,
                ApplicationProperties = _appProperties
                    .Where(p => !string.IsNullOrWhiteSpace(p.Key))
                    .ToDictionary(p => p.Key, p => (object)p.Value),
                BrokerProperties = _brokerProperties
                    .Where(p => !string.IsNullOrWhiteSpace(p.Key))
                    .ToDictionary(p => p.Key, p => (object)p.Value)
            };

            settings.CannedMessages[_cannedEntityName][_cannedScenarioName] = cannedMessage;
            SettingsService.UpdateSettings(settings);

            _result = $"Saved as canned message: {_cannedEntityName}/{_cannedScenarioName}";
            _showSaveDialog = false;
            _cannedEntityName = string.Empty;
            _cannedScenarioName = string.Empty;
        }
        catch (Exception ex)
        {
            _result = $"Error saving canned message: {ex.Message}";
        }
    }
}
